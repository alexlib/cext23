[![Build Status](https://travis-ci.org/jiffyclub/cext23.svg?branch=master)](https://travis-ci.org/jiffyclub/cext23)

# C Extensions for Python 2 and 3

- [Introduction](#introduction)
- [Commonalities](#commonalities)
- [CFFI](#cffi)
- [Cython](#cython)
- [ctypes](#ctypes)
- [Conclusion](#conclusion)
- [Qualifiers](#qualifiers)
- [Wish List](#wish-list)

## Introduction

Writing pure-Python code that runs unmodified on Python 2 & 3 is doable
with the Python standard library [`__future__` module][future] and
packages like [six][] and [python-future][].
Writing C extensions can be another matter because Python's C-API
[changed substantially][cporting] from Python 2 to 3.
Working with the Python C-API can be a lot of work even when you aren't
trying to support two versions of Python so it's no surprise that options
exist to bypass writing the Python-C interface in straight C.
As a bonus these can also help you communicate with compiled C libraries
using the same code in both Python 2 and 3.
(And [here][snarky] are even more reasons to avoid the Python C-API.)
Below I'll be describing how to wrap C code using
[CFFI][], [Cython][], and [ctypes][].

*Note: I'm writing this as someone who has existing C code that I need to
work with. If you don't already have C and are only looking for performance
improvements then you have [other options][perf-alts] you should explore
before deciding to write C.*

## Commonalities

In all of the examples discussed the C code being wrapped is exactly
the same and it won't reference Python at all.
All of the Python to C interface layer will be done in Python and/or
generated by one of the tools discussed below.
The C source used in this example repo lives in the [src/](./src/) directory.

Another thing I've done the same way for each example is that even when
the process creates an importable Python extension I've created a
pure-Python wrapper for it.
That allows me to put a nice Python interface + docstring on the function,
maybe use keyword arguments or do some error checking, all in Python
where it's easy.
The goal is to use the Python wrapper to give users a good experience
while handing the core of the computation off to compiled C.

## CFFI

From the [CFFI homepage][CFFI]:

> C Foreign Function Interface for Python.
> The goal is to provide a convenient and reliable way to call compiled
> C code from Python using interface declarations written in C.

There are a [number of ways][cffi-overview] to use CFFI,
but when interacting with C code the best strategy is what they call
["API level, out-of-line"][cffi-api-level].
In this mode you write a Python file that describes your extension:
what headers to include, what C code to build with, what libraries to
link with, what functions are part of your interface, etc.
CFFI uses that Python to create a C file with your Python-C interface defined
and then compiles that into a library file that you can import into Python.
Check out the example CFFI-build file
[cextcffi_build.py](./cext23/cffi/cextcffi_build.py)
and the wrapping Python module [cextcffi.py](./cext23/cffi/cextcffi.py).

Overall using CFFI was a pleasant experience.
I especially like that it handles gathering up all the C code into
a single library/extension with the same interface as the
[distutils Extension class][distutils-ext].
CFFI also has great [setuptools][] [integration][cffi-dist]
to automatically run the extension building as part of installs.

## Cython

## ctypes

## Conclusion

## Qualifiers

## Wish List

[future]: https://docs.python.org/3/library/__future__.html
[six]: https://pythonhosted.org/six/
[python-future]: http://python-future.org/overview.html
[cporting]: https://docs.python.org/3/howto/cporting.html
[snarky]: http://www.snarky.ca/try-to-not-use-the-c-api-directly
[CFFI]: http://cffi.readthedocs.org/
[Cython]: http://docs.cython.org/
[ctypes]: https://docs.python.org/3/library/ctypes.html
[perf-alts]: https://packaging.python.org/en/latest/extensions/#alternatives-to-handcoded-accelerator-modules
[cffi-overview]: https://cffi.readthedocs.org/en/latest/overview.html
[cffi-api-level]: https://cffi.readthedocs.org/en/latest/overview.html#real-example-api-level-out-of-line
[distutils-ext]: https://docs.python.org/3/distutils/apiref.html#distutils.core.Extension
[setuptools]: https://pythonhosted.org/setuptools/index.html
[cffi-dist]: https://cffi.readthedocs.org/en/latest/cdef.html
